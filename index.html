<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vikrama Kulapati Gun Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .loading-spinner { border-top-color: #3b82f6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        .toast { padding: 12px 24px; border-radius: 8px; color: white; margin-top: 10px; animation: slideIn 0.3s ease-out; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .toast-error { background-color: #ef4444; }
        .toast-success { background-color: #22c55e; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Fix Modal Display */
        .modal-active { display: flex !important; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <div id="toast-container"></div>

    <nav class="bg-slate-900 text-white shadow-lg z-30 border-b border-slate-700 relative">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <img src="https://i.ibb.co.com/dssQMCdF/Hitam-Oranye-Lingkaran-Paguyuban-Kelas-Logo.png" alt="Logo" class="h-10 mr-3 rounded-full bg-white p-0.5 shadow-sm">
                    <div class="flex flex-col">
                        <span class="font-bold text-lg leading-tight tracking-wide uppercase">Vikrama Kulapati</span>
                        <span class="text-xs text-gray-400 tracking-wider">Gun Storage System</span>
                    </div>
                </div>
                <div class="flex space-x-3 items-center">
                    <button onclick="window.openPOS()" class="bg-yellow-500 hover:bg-yellow-600 text-slate-900 px-4 py-2 rounded font-bold transition flex items-center shadow-lg transform hover:scale-105">
                        <i class="fas fa-cash-register mr-2"></i> Kasir
                    </button>
                    <button onclick="document.getElementById('importModal').classList.remove('hidden'); document.getElementById('importModal').classList.add('flex');" class="bg-green-700 hover:bg-green-800 px-3 py-2 rounded text-sm transition font-medium flex items-center">
                        <i class="fas fa-file-excel mr-1"></i> Import
                    </button>
                    <div id="connectionStatus" class="text-xs bg-slate-800 px-2 py-1 rounded flex items-center border border-slate-600 h-8">
                        <div class="w-2 h-2 bg-yellow-400 rounded-full mr-1 animate-pulse"></div> ...
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden relative z-0">
        <aside class="w-64 bg-white shadow-md overflow-y-auto hidden md:block border-r border-gray-200">
            <div class="p-5 border-b bg-gray-50">
                <h2 class="font-bold text-gray-700 uppercase text-xs tracking-wider flex items-center">
                    <i class="fas fa-bars mr-2"></i> Menu Utama
                </h2>
            </div>
            <nav class="mt-2 px-3 pb-4 space-y-1">
                <button onclick="window.switchPage('inventory')" id="menu-inventory" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center bg-blue-100 text-blue-700 font-bold border-l-4 border-blue-600">
                    <i class="fas fa-boxes mr-3"></i> Stok Senjata
                </button>
                <button onclick="window.switchPage('history')" id="menu-history" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center text-gray-600 hover:bg-gray-100">
                    <i class="fas fa-history mr-3"></i> Riwayat Transaksi
                </button>
            </nav>
            
            <div class="p-5 border-b bg-gray-50 mt-4">
                <h2 class="font-bold text-gray-700 uppercase text-xs tracking-wider flex items-center">
                    <i class="fas fa-filter mr-2"></i> Filter Kategori
                </h2>
            </div>
            <nav class="mt-2 px-3 pb-4" id="categoryList">
                </nav>
        </aside>

        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-gray-50">
            <div class="md:hidden mb-4"><select id="mobileCategorySelect" class="w-full p-3 border rounded-lg bg-white shadow-sm font-medium"></select></div>

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h1 id="pageTitle" class="text-2xl font-extrabold text-gray-800 tracking-tight">Semua Senjata</h1>
                    <p class="text-sm text-gray-500">Kelola inventaris dan stok senjata</p>
                </div>
                <div class="flex gap-3 w-full md:w-auto">
                    <input type="text" id="searchInput" placeholder="Cari..." class="w-full md:w-64 px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
                    <button onclick="window.openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-md transition flex items-center font-medium whitespace-nowrap">
                        <i class="fas fa-plus mr-2"></i> Tambah
                    </button>
                </div>
            </div>

            <div id="statsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-600">
                    <div class="text-gray-500 text-xs font-semibold uppercase">Total Item</div>
                    <div class="text-2xl font-bold mt-1" id="totalProducts">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
                    <div class="text-gray-500 text-xs font-semibold uppercase">Total Modal</div>
                    <div class="text-2xl font-bold text-yellow-700 mt-1" id="totalCostValue">Rp 0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-600">
                    <div class="text-gray-500 text-xs font-semibold uppercase">Est. Omzet</div>
                    <div class="text-2xl font-bold text-green-700 mt-1" id="totalSellValue">Rp 0</div>
                </div>
            </div>

            <div id="loadingState" class="flex justify-center items-center h-64"><div class="loading-spinner rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div></div>
            <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 hidden"></div>
            
            <div id="historyView" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-900 text-white uppercase font-bold text-xs">
                            <tr>
                                <th class="px-6 py-4">Tanggal</th>
                                <th class="px-6 py-4">Kelompok & PIC</th>
                                <th class="px-6 py-4">Detail Barang</th>
                                <th class="px-6 py-4 text-right">Total Transaksi</th>
                                <th class="px-6 py-4 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                <div id="emptyHistory" class="hidden p-10 text-center text-gray-400">
                    <i class="fas fa-receipt text-4xl mb-3"></i>
                    <p>Belum ada riwayat transaksi.</p>
                </div>
            </div>
            <div id="emptyState" class="hidden flex flex-col items-center justify-center h-64 text-gray-400"><i class="fas fa-crosshairs text-6xl mb-4 opacity-30"></i><p>Tidak ada data.</p></div>
        </main>
    </div>

    <div id="posModal" class="fixed inset-0 bg-gray-100 z-40 hidden flex-col">
        <div class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-md shrink-0">
            <div class="flex items-center"><i class="fas fa-cash-register text-2xl text-yellow-500 mr-3"></i><h2 class="font-bold text-xl">POS System</h2></div>
            <button onclick="window.closePOS()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm font-bold"><i class="fas fa-times mr-1"></i> Tutup</button>
        </div>
        <div class="flex flex-1 overflow-hidden">
            <div class="flex-1 flex flex-col p-4 border-r border-gray-300 bg-gray-50">
                <div class="mb-4 flex gap-2">
                    <input type="text" id="posSearchInput" placeholder="Cari produk..." class="flex-1 px-4 py-3 border border-gray-300 rounded-lg shadow-sm text-lg">
                    <select id="posCategoryFilter" class="w-1/3 px-3 py-3 border border-gray-300 rounded-lg shadow-sm bg-white font-medium"></select>
                </div>
                <div id="posProductGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 overflow-y-auto p-1 pb-20"></div>
            </div>
            <div class="w-full md:w-96 bg-white shadow-xl flex flex-col shrink-0 z-10">
                <div class="w-full md:w-96 bg-white shadow-xl flex flex-col shrink-0 z-10 border-l border-gray-200">
                
                <div class="p-4 bg-gray-100 border-b border-gray-200 space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Tanggal Transaksi</label>
                        <input type="date" id="posDate" class="w-full px-3 py-2 border rounded font-medium text-gray-700 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Nama Kelompok</label>
                            <input type="text" id="posGroup" placeholder="Contoh: Yakuza" class="w-full px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">PIC / Penanggung Jawab</label>
                            <input type="text" id="posPic" placeholder="Contoh: Don Billy" class="w-full px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-blue-50 border-b border-blue-100"><h3 class="font-bold text-blue-900"><i class="fas fa-shopping-cart mr-2"></i> Keranjang</h3></div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3" id="cartItems"></div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 space-y-2">
                    <div class="flex justify-between items-end border-t border-gray-200 pt-2">
                        <span class="font-bold text-gray-800 text-lg">Total Tagihan:</span>
                        <span class="font-bold text-2xl text-blue-600" id="cartTotalSell">Rp 0</span>
                    </div>
                    <button onclick="window.processCheckout()" id="btnCheckout" disabled class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-3 rounded-lg shadow-lg transition mt-2">Proses Transaksi</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md relative">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-lg font-bold" id="modalTitle">Tambah Data</h3>
                <button onclick="window.closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <form id="productForm" class="p-5 space-y-4">
                <input type="hidden" id="productId">
                <div><label class="block text-sm font-medium mb-1">Nama</label><input type="text" id="name" required class="w-full px-3 py-2 border rounded-lg"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium mb-1">Kategori</label><select id="category" required class="w-full px-3 py-2 border rounded-lg"></select></div>
                    <div><label class="block text-sm font-medium mb-1">Stok</label><input type="number" id="stock" required min="0" class="w-full px-3 py-2 border rounded-lg"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium mb-1">Modal (Rp)</label><input type="number" id="costPrice" required class="w-full px-3 py-2 border rounded-lg bg-gray-50"></div>
                    <div><label class="block text-sm font-medium mb-1">Jual (Rp)</label><input type="number" id="sellingPrice" required class="w-full px-3 py-2 border rounded-lg font-bold text-green-700"></div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">Simpan</button>
            </form>
        </div>
    </div>

    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="p-5 border-b"><h3 class="text-lg font-bold">Import Excel</h3></div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-4">Header kolom wajib: <code>nama</code>, <code>kategori</code>, <code>modal</code>, <code>jual</code>, <code>stok</code></p>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center relative hover:bg-gray-50">
                    <input type="file" id="excelInput" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    <i class="fas fa-file-excel text-4xl text-green-500 mb-2"></i>
                    <p class="text-gray-500 font-medium">Klik untuk upload file Excel</p>
                </div>
                <div id="importStatus" class="mt-4 text-sm hidden"></div>
            </div>
            <div class="p-5 border-t bg-gray-50 flex justify-end"><button onclick="document.getElementById('importModal').classList.remove('flex'); document.getElementById('importModal').classList.add('hidden')" class="text-gray-600 font-medium px-4">Tutup</button></div>
        </div>
    </div>

    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4"><i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i></div>
            <h3 class="text-lg font-medium mb-2">Konfirmasi</h3>
            <p class="text-sm text-gray-500 mb-6" id="confirmMessage">Yakin?</p>
            <div class="flex justify-center gap-3">
                <button onclick="window.confirmNo()" class="px-4 py-2 bg-gray-200 rounded-lg">Batal</button>
                <button onclick="window.confirmYes()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Ya</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

  
        const firebaseConfig = {
            apiKey: "AIzaSyD9NymFd2G46ipaQXsOUJEZSXqcgNZDUA8",
  authDomain: "vikrama-storage.firebaseapp.com",
  projectId: "vikrama-storage",
  storageBucket: "vikrama-storage.firebasestorage.app",
  messagingSenderId: "521669285666",
  appId: "1:521669285666:web:b1fce2336db5317795777b"
        };

        // --- GLOBAL VARIABLES ---
        const CATEGORIES = ['Semua', 'Kelas 1', 'Kelas 2', 'Kelas 3', 'Kelas 4', 'Aksesoris'];
        let db, auth, user, allProducts = [], posCart = [];
        let currentCategory = 'Semua', searchTerm = '', posCategory = 'Semua', posSearch = '';

        // --- INIT APP ---
        function initApp() {
            if (!firebaseConfig.apiKey) { alert("Config Kosong!"); return; }
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            renderLockScreen();

            signInAnonymously(auth).then(()=>{
                document.getElementById('connectionStatus').innerHTML='<span class="text-green-400 font-bold">Online</span>';
                
                // --- TAMBAHKAN BARIS INI (PAKSA RESET TAMPILAN) ---
                window.switchPage('inventory'); 
                // --------------------------------------------------
                
                subscribeData(); // Baru load data
            }).catch(e=>console.error(e));
        }

        // --- FITUR KEAMANAN (LOCK SCREEN) ---
        function renderLockScreen() {
            // Buat elemen Lock Screen menutupi seluruh layar
            const lockDiv = document.createElement('div');
            lockDiv.id = 'appLockScreen';
            lockDiv.className = 'fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center p-4';
            lockDiv.innerHTML = `
                <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                    <div class="w-16 h-16 bg-slate-900 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-lock text-yellow-500 text-2xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Akses Terbatas</h2>
                    <p class="text-sm text-gray-500 mb-6">Masukkan PIN Akses Vikrama Kulapati</p>
                    
                    <input type="password" id="pinInput" placeholder="Masukan PIN" class="w-full text-center text-2xl tracking-widest font-bold border-2 border-gray-300 rounded-lg py-3 px-4 mb-4 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition">
                    
                    <button id="btnUnlock" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-lg transition transform active:scale-95">
                        BUKA AKSES
                    </button>
                    <p id="pinError" class="text-red-500 text-xs mt-3 hidden font-bold">PIN Salah!</p>
                </div>
            `;
            document.body.appendChild(lockDiv);

            // Cek apakah sudah pernah login sebelumnya di browser ini?
            const savedPin = localStorage.getItem('vikrama_pin_session');
            if(savedPin) {
                checkPin(savedPin, true); // Auto login jika ada sesi
            }

            // Event Listeners
            document.getElementById('btnUnlock').onclick = () => checkPin(document.getElementById('pinInput').value);
            document.getElementById('pinInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') checkPin(e.target.value); });
        }

        async function checkPin(inputPin, isAuto = false) {
            const btn = document.getElementById('btnUnlock');
            const err = document.getElementById('pinError');
            if(btn) { btn.innerText = "Mengecek..."; btn.disabled = true; }
            
            try {
                // Ambil PIN asli dari Database (Collection: settings, Doc: security)
                const docRef = doc(db, 'settings', 'security');
                const snap = await getDoc(docRef);

                let correctPin = '123456'; // Default jika database belum disetting
                if (snap.exists()) {
                    correctPin = snap.data().pin;
                }

                if (inputPin === correctPin) {
                    // SUKSES
                    document.getElementById('appLockScreen').remove();
                    localStorage.setItem('vikrama_pin_session', inputPin); // Simpan sesi
                    subscribeData(); // Baru load data inventory setelah jebol
                    showToast("Akses Diterima", "success");
                } else {
                    // GAGAL
                    if(isAuto) {
                        localStorage.removeItem('vikrama_pin_session'); // Hapus sesi invalid
                        if(btn) { btn.innerText = "BUKA AKSES"; btn.disabled = false; }
                    } else {
                        if(err) err.classList.remove('hidden');
                        if(btn) { btn.innerText = "BUKA AKSES"; btn.disabled = false; }
                        document.getElementById('pinInput').value = '';
                        document.getElementById('pinInput').focus();
                    }
                }
            } catch (e) {
                console.error(e);
                alert("Gagal koneksi ke database security.");
                if(btn) { btn.innerText = "COBA LAGI"; btn.disabled = false; }
            }
        }

        // --- CORE FUNCTIONS (Sama seperti sebelumnya) ---
        function subscribeData() {
            // Inventory Listener (DENGAN PENGECUALIAN ERROR)
            const q = collection(db, 'vikrama_inventory');
            onSnapshot(q, (snap) => {
                document.getElementById('loadingState').classList.add('hidden');
                
                if (snap.empty) {
                    console.log("Data Firebase Kosong/Tidak Ditemukan");
                }

                allProducts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                allProducts.sort((a, b) => (a.name||'').localeCompare(b.name||''));
                
                renderProducts();
                if(!document.getElementById('posModal').classList.contains('hidden')) renderPosProducts();
            }, (error) => {
                // INI AKAN MEMUNCULKAN PENYEBABNYA
                alert("Gagal mengambil data: " + error.message);
                console.error("Firebase Error:", error);
            });

            // History Listener
            loadHistoryData();
        }

        // --- RENDER PRODUK (VERSI ANTI-CRASH) ---
        function renderProducts() {
            // 1. Cek Elemen dengan Aman (Pakai tanda tanya ?)
            const historyView = document.getElementById('historyView');
            // Jika elemen history tidak ketemu, anggap saja kita sedang di Inventory (false)
            const isHistoryOpen = historyView ? !historyView.classList.contains('hidden') : false;

            const grid = document.getElementById('productGrid');
            if(!grid) return; // Stop jika grid hilang
            
            grid.innerHTML = '';
            
            const filtered = allProducts.filter(p => {
                const c = currentCategory === 'Semua' || p.category === currentCategory;
                const s = p.name ? p.name.toLowerCase().includes(searchTerm) : false;
                return c && s;
            });

            // Update Stats
            if(document.getElementById('totalProducts')) document.getElementById('totalProducts').innerText = filtered.length;
            
            const totalModal = filtered.reduce((a, b) => a + ((b.costPrice||0)*b.stock), 0);
            if(document.getElementById('totalCostValue')) document.getElementById('totalCostValue').innerText = 'Rp ' + totalModal.toLocaleString('id-ID');
            
            const totalOmzet = filtered.reduce((a, b) => a + ((b.sellingPrice||0)*b.stock), 0);
            if(document.getElementById('totalSellValue')) document.getElementById('totalSellValue').innerText = 'Rp ' + totalOmzet.toLocaleString('id-ID');
            
            if(document.getElementById('totalMarginValue')) document.getElementById('totalMarginValue').innerText = 'Rp ' + (totalOmzet - totalModal).toLocaleString('id-ID');

            // --- LOGIC TAMPILAN AMAN ---
            if (filtered.length === 0) {
                if(document.getElementById('emptyState')) document.getElementById('emptyState').classList.remove('hidden');
                grid.classList.add('hidden');
            } else {
                if(document.getElementById('emptyState')) document.getElementById('emptyState').classList.add('hidden');
                
                // HANYA sembunyikan grid jika history BENAR-BENAR terbuka
                if (isHistoryOpen) {
                    grid.classList.add('hidden'); 
                } else {
                    grid.classList.remove('hidden'); // Paksa muncul
                }
            }

            // Render Kartu (Hanya jika TIDAK di history)
            if (!isHistoryOpen) {
                filtered.forEach(p => {
                    let badge = 'bg-gray-100 text-gray-600';
                    if(p.category?.includes('1')) badge='bg-red-100 text-red-600';
                    if(p.category?.includes('2')) badge='bg-orange-100 text-orange-600';
                    if(p.category?.includes('3')) badge='bg-yellow-100 text-yellow-600';
                    if(p.category?.includes('4')) badge='bg-blue-100 text-blue-600';
                    if(p.category === 'Aksesoris') badge='bg-purple-100 text-purple-600';

                    const el = document.createElement('div');
                    el.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-5 card-hover relative group flex flex-col justify-between';
                    el.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[10px] uppercase font-bold px-2 py-1 rounded-full ${badge}">${p.category}</span>
                                <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="window.editProduct('${p.id}')" class="text-blue-500 mr-2 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                                    <button onclick="window.deleteProduct('${p.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <h3 class="font-bold text-gray-800 mb-2 leading-tight">${p.name}</h3>
                            <div class="bg-gray-50 p-2 rounded border border-gray-100 mb-3">
                                <div class="flex justify-between text-xs mb-1 text-gray-500"><span>Modal:</span><span>Rp ${(p.costPrice||0).toLocaleString('id-ID')}</span></div>
                                <div class="flex justify-between font-bold text-green-700 text-sm"><span>Jual:</span><span>Rp ${(p.sellingPrice||0).toLocaleString('id-ID')}</span></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between pt-3 border-t">
                            <div class="text-xs text-gray-500 uppercase font-semibold">Stok</div>
                            <div class="flex items-center">
                                <button onclick="window.updateStock('${p.id}', -1)" class="w-7 h-7 bg-gray-200 rounded-full font-bold hover:bg-gray-300 transition">-</button>
                                <span class="mx-2 font-mono font-bold w-6 text-center">${p.stock}</span>
                                <button onclick="window.updateStock('${p.id}', 1)" class="w-7 h-7 bg-blue-100 text-blue-700 rounded-full font-bold hover:bg-blue-200 transition">+</button>
                            </div>
                        </div>`;
                    grid.appendChild(el);
                });
            }
        }

        function loadHistoryData() {
            const tbody = document.getElementById('transactionTableBody');
            onSnapshot(collection(db, 'vikrama_transactions'), (snapshot) => {
                const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                transactions.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));

                let totalCuan = 0;
                transactions.forEach(t => totalCuan += (t.totalProfit !== undefined ? t.totalProfit : (t.totalPrice - (t.totalCost||0))));
                const profitEl = document.getElementById('realizedProfitValue');
                if(profitEl) profitEl.innerText = 'Rp ' + totalCuan.toLocaleString('id-ID');

                if (document.getElementById('historyView').classList.contains('hidden')) return;

                tbody.innerHTML = '';
                if (transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-gray-400">Belum ada riwayat.</td></tr>';
                    return;
                }

                transactions.forEach(trx => {
                    const items = (trx.items||[]).map(i => `<span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold mr-1 border">${i.name} (${i.qty})</span>`).join(' ');
                    const row = `
                        <tr class="hover:bg-gray-50 transition border-b group">
                            <td class="px-6 py-4 text-gray-600 align-top font-bold text-sm">${trx.date}</td>
                            <td class="px-6 py-4 align-top">
                                <div class="font-bold text-gray-800 text-sm">${trx.groupName||'-'}</div>
                                <div class="text-xs text-gray-500">${trx.picName||'-'}</div>
                            </td>
                            <td class="px-6 py-4 align-top"><div class="flex flex-wrap gap-1">${items}</div></td>
                            <td class="px-6 py-4 align-top text-right font-bold text-green-700">Rp ${(trx.totalPrice||0).toLocaleString('id-ID')}</td>
                            <td class="px-6 py-4 align-top text-right">
                                <button onclick="window.deleteTrx('${trx.id}')" class="bg-red-50 text-red-500 hover:bg-red-100 p-2 rounded transition" title="Hapus"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    tbody.innerHTML += row;
                });
            });
        }

        // --- GLOBAL & HELPERS ---
        window.switchPage = (page) => {
            const btnInv = document.getElementById('menu-inventory'), btnHis = document.getElementById('menu-history');
            const grid = document.getElementById('productGrid'), history = document.getElementById('historyView'), stats = document.querySelector('.grid.grid-cols-1.sm\\:grid-cols-2');

            if (page === 'inventory') {
                btnInv.className = "w-full text-left px-4 py-3 rounded-lg transition flex items-center bg-blue-100 text-blue-700 font-bold border-l-4 border-blue-600";
                btnHis.className = "w-full text-left px-4 py-3 rounded-lg transition flex items-center text-gray-600 hover:bg-gray-100";
                grid.classList.remove('hidden'); history.classList.add('hidden');
                document.getElementById('pageTitle').innerText = "Stok Senjata";
                if(stats) stats.classList.remove('hidden');
                renderProducts();
            } else {
                btnHis.className = "w-full text-left px-4 py-3 rounded-lg transition flex items-center bg-purple-100 text-purple-700 font-bold border-l-4 border-purple-600";
                btnInv.className = "w-full text-left px-4 py-3 rounded-lg transition flex items-center text-gray-600 hover:bg-gray-100";
                grid.classList.add('hidden'); history.classList.remove('hidden');
                document.getElementById('pageTitle').innerText = "Riwayat Transaksi";
                if(stats) stats.classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');
                loadHistoryData();
            }
        };

        window.deleteTrx = (id) => {
            window.showConfirm("Hapus? Stok barang akan kembali ke gudang.", async (y) => {
                if(!y) return;
                try {
                    const ref = doc(db, 'vikrama_transactions', id);
                    const snap = await getDoc(ref);
                    if(snap.exists()) {
                        const d = snap.data();
                        for(const item of (d.items||[])) {
                            const p = allProducts.find(x => x.name === item.name);
                            if(p) await updateDoc(doc(db, 'vikrama_inventory', p.id), { stock: (p.stock||0) + item.qty });
                        }
                        await deleteDoc(ref);
                        showToast("Dihapus & Stok Kembali", "success");
                    }
                } catch(e) { showToast("Gagal Hapus", "error"); console.error(e); }
            });
        };

        window.openPOS=()=>{document.getElementById('posModal').classList.remove('hidden');document.getElementById('posDate').valueAsDate=new Date();posCart=[];renderCart();renderPosProducts();};
        window.closePOS=()=>{if(posCart.length>0)window.showConfirm("Batal?",y=>{if(y)document.getElementById('posModal').classList.add('hidden')});else document.getElementById('posModal').classList.add('hidden');};
        window.filterCategory=(c)=>{currentCategory=c;renderProducts();document.getElementById('pageTitle').innerText=c;};
        
        window.addToCart=(id)=>{
            const p=allProducts.find(x=>x.id===id); if(!p||p.stock<=0)return showToast("Stok Habis","error");
            const x=posCart.find(i=>i.id===id);
            if(x){if(x.qty<p.stock)x.qty++;else showToast("Max Stok","error");}
            else posCart.push({id:p.id,name:p.name,price:p.sellingPrice||0,cost:p.costPrice||0,qty:1,max:p.stock});
            renderCart();
        };
        window.updateCartQty=(id,v)=>{const i=posCart.find(x=>x.id===id);if(i){const n=i.qty+v;if(n>i.max)showToast("Limit","error");else if(n<=0)posCart=posCart.filter(x=>x.id!==id);else i.qty=n;renderCart();}};
        window.removeFromCart=(id)=>{posCart=posCart.filter(x=>x.id!==id);renderCart();};
        
        function renderPosProducts(){const g=document.getElementById('posProductGrid');g.innerHTML='';allProducts.filter(p=>(posCategory==='Semua'||p.category===posCategory)&&(p.name||'').toLowerCase().includes(posSearch)&&p.stock>0).forEach(p=>{g.innerHTML+=`<div onclick="window.addToCart('${p.id}')" class="bg-white border rounded p-3 cursor-pointer hover:border-blue-500"><div class="text-xs bg-gray-100 inline px-1 rounded">${p.category}</div><div class="font-bold text-sm my-1">${p.name}</div><div class="flex justify-between text-xs text-gray-500"><span>Stok: ${p.stock}</span><span class="font-bold text-green-700">${(p.sellingPrice||0).toLocaleString()}</span></div></div>`});}
        function renderCart(){const c=document.getElementById('cartItems');c.innerHTML='';let t=0;if(posCart.length===0){c.innerHTML='<div class="text-center text-gray-400 mt-10">Kosong</div>';document.getElementById('btnCheckout').disabled=true;}else{posCart.forEach(i=>{t+=i.price*i.qty;c.innerHTML+=`<div class="flex justify-between items-center bg-gray-50 p-2 rounded mb-2 border"><div class="flex-1 font-bold text-sm">${i.name}</div><div class="flex items-center gap-2"><button onclick="window.updateCartQty('${i.id}',-1)" class="w-6 bg-gray-200 rounded">-</button><span>${i.qty}</span><button onclick="window.updateCartQty('${i.id}',1)" class="w-6 bg-blue-100 rounded">+</button></div><div class="text-right text-sm font-bold ml-2">${(i.price*i.qty).toLocaleString()}</div></div>`});document.getElementById('btnCheckout').disabled=false;}document.getElementById('cartTotalSell').innerText='Rp '+t.toLocaleString('id-ID');}

        window.processCheckout=()=>{
            const d=document.getElementById('posDate').value, g=document.getElementById('posGroup').value, pic=document.getElementById('posPic').value;
            if(!d||!g||!pic)return showToast("Lengkapi Data!","error");
            window.showConfirm("Proses?",async y=>{
                if(!y)return;
                try{
                    let ts=0,tc=0;
                    for(const i of posCart){
                        const p=allProducts.find(x=>x.id===i.id);
                        if(p)await updateDoc(doc(db,'vikrama_inventory',i.id),{stock:Math.max(0,p.stock-i.qty)});
                        ts+=i.price*i.qty; tc+=i.cost*i.qty;
                    }
                    await addDoc(collection(db,'vikrama_transactions'),{date:d,groupName:g,picName:pic,items:posCart,totalPrice:ts,totalCost:tc,totalProfit:ts-tc,createdAt:new Date().toISOString()});
                    posCart=[];renderCart();document.getElementById('posModal').classList.add('hidden');showToast("Sukses","success");
                }catch(e){showToast("Error","error");}
            });
        };

        // Listeners & CRUD
        document.getElementById('searchInput').addEventListener('input',e=>{searchTerm=e.target.value.toLowerCase();renderProducts();});
        document.getElementById('posSearchInput').addEventListener('input',e=>{posSearch=e.target.value.toLowerCase();renderPosProducts();});
        document.getElementById('posCategoryFilter').addEventListener('change',e=>{posCategory=e.target.value;renderPosProducts();});
        window.openModal=()=>{document.getElementById('productForm').reset();document.getElementById('productId').value='';document.getElementById('modalTitle').innerText='Tambah Data';document.getElementById('productModal').classList.remove('hidden');};
        window.closeModal=()=>{document.getElementById('productModal').classList.add('hidden');};
        window.editProduct=(id)=>{const p=allProducts.find(x=>x.id===id);if(!p)return;document.getElementById('productId').value=id;document.getElementById('name').value=p.name;document.getElementById('category').value=p.category;document.getElementById('stock').value=p.stock;document.getElementById('costPrice').value=p.costPrice;document.getElementById('sellingPrice').value=p.sellingPrice;document.getElementById('productModal').classList.remove('hidden');};
        window.deleteProduct=(id)=>{window.showConfirm("Hapus item?",async y=>{if(y)await deleteDoc(doc(db,'vikrama_inventory',id));});};
        window.updateStock=async(id,v)=>{const p=allProducts.find(x=>x.id===id);if(p){const n=(p.stock||0)+v;if(n>=0)await updateDoc(doc(db,'vikrama_inventory',id),{stock:n});}};
        document.getElementById('productForm').addEventListener('submit',async e=>{e.preventDefault();const id=document.getElementById('productId').value, d={name:document.getElementById('name').value,category:document.getElementById('category').value,stock:parseInt(document.getElementById('stock').value)||0,costPrice:parseInt(document.getElementById('costPrice').value)||0,sellingPrice:parseInt(document.getElementById('sellingPrice').value)||0};try{if(id)await updateDoc(doc(db,'vikrama_inventory',id),d);else await addDoc(collection(db,'vikrama_inventory'),d);window.closeModal();showToast("Sukses","success");}catch{showToast("Gagal","error");}});

        // Excel Import
        const xl=document.getElementById('excelInput');
        if(xl)xl.addEventListener('change',async e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=async ev=>{try{const wb=XLSX.read(new Uint8Array(ev.target.result),{type:'array'}),js=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);for(const row of js){const k=Object.keys(row),find=a=>row[k.find(x=>a.some(s=>x.toLowerCase().includes(s)))];await addDoc(collection(db,'vikrama_inventory'),{name:find(['nama','name'])||'Item',category:find(['kat','cat'])||'Aksesoris',stock:parseInt(find(['stok','qty']))||0,costPrice:parseInt(find(['modal','cost']))||0,sellingPrice:parseInt(find(['jual','price']))||0});}document.getElementById('importModal').classList.add('hidden');xl.value='';showToast("Import Sukses","success");}catch(err){alert(err.message);}};r.readAsArrayBuffer(f);});

        // Setup UI
        const nav=document.getElementById('categoryList'), posSel=document.getElementById('posCategoryFilter'), formSel=document.getElementById('category'), mobSel=document.getElementById('mobileCategorySelect');
        CATEGORIES.forEach(c=>{nav.innerHTML+=`<button onclick="window.filterCategory('${c}')" class="w-full text-left px-4 py-2 rounded-lg mb-1 hover:bg-gray-100 text-gray-600">${c}</button>`;posSel.innerHTML+=`<option value="${c}">${c}</option>`;mobSel.innerHTML+=`<option value="${c}">${c}</option>`;if(c!=='Semua')formSel.innerHTML+=`<option value="${c}">${c}</option>`;});
        mobSel.addEventListener('change',e=>window.filterCategory(e.target.value));
        function showToast(m,t){const d=document.createElement('div');d.className=`toast ${t==='success'?'toast-success':'toast-error'}`;d.innerText=m;document.getElementById('toast-container').appendChild(d);setTimeout(()=>d.remove(),3000);}
        let cfm;window.showConfirm=(m,c)=>{document.getElementById('confirmMessage').innerText=m;document.getElementById('confirmationModal').classList.remove('hidden');cfm=c;};window.confirmYes=()=>{document.getElementById('confirmationModal').classList.add('hidden');if(cfm)cfm(true);};window.confirmNo=()=>{document.getElementById('confirmationModal').classList.add('hidden');if(cfm)cfm(false);};

        // START
        initApp();
    </script>
</body>
</html>
